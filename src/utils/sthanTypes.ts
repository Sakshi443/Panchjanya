// src/utils/sthanTypes.ts
import { collection, getDocs, addDoc, updateDoc, deleteDoc, doc, query, orderBy, Timestamp } from 'firebase/firestore';
import { db } from '@/firebase';
import { SthanType, CreateSthanTypeInput, UpdateSthanTypeInput } from '@/types/sthanType';

const STHAN_TYPES_COLLECTION = 'sthan_types';

/**
 * Fetch all sthan types from Firestore
 */
export const getSthanTypes = async (): Promise<SthanType[]> => {
    try {
        const q = query(collection(db, STHAN_TYPES_COLLECTION), orderBy('order', 'asc'));
        const snapshot = await getDocs(q);

        return snapshot.docs.map(doc => ({
            id: doc.id,
            ...doc.data(),
        } as SthanType));
    } catch (error) {
        console.error('Error fetching sthan types:', error);
        return [];
    }
};

/**
 * Create a new sthan type
 */
export const createSthanType = async (data: CreateSthanTypeInput): Promise<string> => {
    try {
        const docRef = await addDoc(collection(db, STHAN_TYPES_COLLECTION), {
            ...data,
            createdAt: new Date().toISOString(),
            updatedAt: new Date().toISOString(),
        });
        return docRef.id;
    } catch (error) {
        console.error('Error creating sthan type:', error);
        throw error;
    }
};

/**
 * Update an existing sthan type
 */
export const updateSthanType = async (id: string, data: UpdateSthanTypeInput): Promise<void> => {
    try {
        const docRef = doc(db, STHAN_TYPES_COLLECTION, id);
        await updateDoc(docRef, {
            ...data,
            updatedAt: new Date().toISOString(),
        });
    } catch (error) {
        console.error('Error updating sthan type:', error);
        throw error;
    }
};

/**
 * Delete a sthan type
 */
export const deleteSthanType = async (id: string): Promise<void> => {
    try {
        const docRef = doc(db, STHAN_TYPES_COLLECTION, id);
        await deleteDoc(docRef);
    } catch (error) {
        console.error('Error deleting sthan type:', error);
        throw error;
    }
};

/**
 * Generate SVG pin data URL with custom color
 */
export const generateSthanPinSVG = (color: string): string => {
    // Calculate complementary/darker shades based on the main color
    const darkerShade = adjustColorBrightness(color, -20);
    const lighterShade = adjustColorBrightness(color, 20);

    const svg = `<?xml version="1.0" encoding="UTF-8"?>
<svg version="1.1" xmlns="http://www.w3.org/2000/svg" width="500" height="500">
<path d="M0 0 C1.18258896 -0.00421463 1.18258896 -0.00421463 2.3890686 -0.0085144 C17.09668022 -0.00256496 31.29709088 1.9124912 45.375 6.3125 C46.20878174 6.56926514 47.04256348 6.82603027 47.90161133 7.09057617 C55.99346861 9.65715305 63.68337967 12.85408248 71.3125 16.5625 C71.99908691 16.89088867 72.68567383 17.21927734 73.39306641 17.55761719 C89.64729373 25.4178704 103.39663574 36.01408565 116.3125 48.5625 C116.86429932 49.09166016 117.41609863 49.62082031 117.98461914 50.16601562 C147.56385278 78.99996498 163.41718702 121.01841662 164.78442383 161.84448242 C165.46320359 224.53421984 122.47652912 293.90107807 91.97509766 346.68310547 C90.20795776 349.74355304 88.45302234 352.81079861 86.69921875 355.87890625 C73.94617149 378.1446772 60.72345205 400.10178198 47.04541016 421.81103516 C45.43674635 424.36522522 43.83287538 426.92235033 42.23046875 429.48046875 C31.5737055 446.46263938 20.59619742 463.24062684 9.43115234 479.89257812 C7.51146066 482.75828985 5.59992729 485.62943768 3.6875 488.5 C2 491.03125 2 491.03125 0.3125 493.5625 C-3.8590242 492.17199193 -5.1744977 489.23403421 -7.44921875 485.6875 C-7.91209793 484.97991043 -8.37497711 484.27232086 -8.85188293 483.54328918 C-10.36767755 481.22151552 -11.8714748 478.89223413 -13.375 476.5625 C-14.42127775 474.95363162 -15.46815666 473.34515403 -16.515625 471.73706055 C-19.58438556 467.01958252 -22.63712827 462.29188067 -25.6875 457.5625 C-26.48896717 456.32234573 -27.29055174 455.08226732 -28.09228516 453.84228516 C-41.47085464 433.12757177 -54.61730967 412.2628081 -67.20605469 391.05761719 C-68.71999073 388.50777765 -70.23888099 385.96092876 -71.7578125 383.4140625 C-85.62903974 360.10284358 -99.01955526 336.55051741 -111.6875 312.5625 C-112.32780208 311.35603478 -112.96826782 310.1496564 -113.60888672 308.94335938 C-128.98241912 279.95077249 -142.59864279 250.46659873 -153.6875 219.5625 C-154.00541504 218.69641113 -154.32333008 217.83032227 -154.65087891 216.93798828 C-156.51088682 211.85982166 -158.18598735 206.75786945 -159.6875 201.5625 C-159.92726563 200.75377441 -160.16703125 199.94504883 -160.4140625 199.11181641 C-163.97735383 186.66608374 -165.16154427 174.51677158 -165.1875 161.625 C-165.19423737 160.60223465 -165.19423737 160.60223465 -165.20111084 159.55880737 C-165.22880358 149.24108276 -163.89843693 139.61364366 -161.6875 129.5625 C-161.38972656 128.19387817 -161.38972656 128.19387817 -161.0859375 126.79760742 C-155.65643629 103.06567076 -145.13418402 81.43043304 -129.6875 62.5625 C-129.24325684 62.01287598 -128.79901367 61.46325195 -128.34130859 60.89697266 C-107.37451174 35.08227835 -79.73041269 16.03555019 -47.6875 6.5625 C-46.71619141 6.2747168 -45.74488281 5.98693359 -44.74414062 5.69042969 C-29.79789012 1.46729909 -15.4470298 0.00285109 0 0 Z " fill="${color}" transform="translate(270.6875,2.4375)"/>
<path d="M0 0 C17.77812368 14.98096049 29.49947374 34.84912009 32.58203125 58.17578125 C33.99760918 84.2550823 26.77896949 107.2549005 9.58203125 127.17578125 C8.9890625 127.86542969 8.39609375 128.55507812 7.78515625 129.265625 C-6.18200737 144.33703019 -27.74559782 153.57044143 -48.08984375 154.5234375 C-70.87549346 155.09641327 -90.05610544 149.92646986 -108.41796875 136.17578125 C-109.12050781 135.65757812 -109.82304687 135.139375 -110.546875 134.60546875 C-121.92457867 125.4573353 -129.97068686 112.55153469 -135.41796875 99.17578125 C-135.68899414 98.51191406 -135.96001953 97.84804687 -136.23925781 97.1640625 C-143.8439767 77.48126067 -143.07328813 53.35166505 -134.6875 34.1484375 C-124.3560916 11.63695355 -107.17107518 -4.20847124 -84.41796875 -13.82421875 C-55.20143425 -23.93172648 -24.5187649 -18.93128024 0 0 Z " fill="#F5F6F6" transform="translate(324.41796875,90.82421875)"/>
<path d="M0 0 C27.06 0 54.12 0 82 0 C82 15.51 82 31.02 82 47 C72.43 47 62.86 47 53 47 C52.75 34.8125 52.75 34.8125 52.70214844 30.99536133 C52.65622559 29.49138794 52.65622559 29.49138794 52.609375 27.95703125 C52.58842773 26.93585205 52.56748047 25.91467285 52.54589844 24.86254883 C51.86296201 21.28140859 50.53388653 19.58195093 48 17 C44.32872385 15.77624128 40.78168337 15.11252965 37 16 C33.94892233 17.57942511 32.77826256 18.19518705 31 21 C30.10417606 25.60403844 30.11670899 30.13333307 30.125 34.8125 C30.063125 41.3403125 30.063125 41.3403125 30 48 C20.1 48 10.2 48 0 48 C0 32.16 0 16.32 0 0 Z " fill="${darkerShade}" transform="translate(229,152)"/>
<path d="M0 0 C3.875 1.875 3.875 1.875 5 3 C5.04080783 4.99958364 5.04254356 7.00045254 5 9 C7.475 9.495 7.475 9.495 10 10 C12.29612756 19.41002278 12.29612756 19.41002278 12 24 C13.98 24 15.96 24 18 24 C18.495 26.475 18.495 26.475 19 29 C17.68 29 16.36 29 15 29 C15.495 32.465 15.495 32.465 16 36 C17.65 36 19.3 36 21 36 C21.93423645 39.01031744 22.04449911 39.86650268 21 43 C21.87914688 45.6569191 21.87914688 45.6569191 23 48 C24.32 48 25.64 48 27 48 C27.226875 48.721875 27.45375 49.44375 27.6875 50.1875 C29.44949326 53.96319984 30.51416118 55.58672697 34 58 C38.66364252 58.72522023 43.28478192 58.92981407 48 59 C48 60.98 48 62.96 48 65 C17.31 65 -13.38 65 -45 65 C-45 63.02 -45 61.04 -45 59 C-40.38 59 -35.76 59 -31 59 C-30.34 57.68 -29.68 56.36 -29 55 C-28.319375 54.690625 -27.63875 54.38125 -26.9375 54.0625 C-25.9784375 53.5365625 -25.9784375 53.5365625 -25 53 C-24.18828772 50.44480079 -24.18828772 50.44480079 -24 48 C-22.68 48 -21.36 48 -20 48 C-19.34 45.69 -18.68 43.38 -18 41 C-18.66 40.67 -19.32 40.34 -20 40 C-19.67 38.68 -19.34 37.36 -19 36 C-16.525 35.505 -16.525 35.505 -14 35 C-13.34 33.02 -12.68 31.04 -12 29 C-13.32 29 -14.64 29 -16 29 C-15.67 27.35 -15.34 25.7 -15 24 C-13.35 23.67 -11.7 23.34 -10 23 C-9.89042969 22.16855469 -9.78085937 21.33710937 -9.66796875 20.48046875 C-9.50941406 19.39378906 -9.35085938 18.30710937 -9.1875 17.1875 C-9.03667969 16.10855469 -8.88585937 15.02960938 -8.73046875 13.91796875 C-7.98249202 10.93006172 -7.47178858 9.7744578 -5 8 C-4.34 8 -3.68 8 -3 8 C-2.814375 6.576875 -2.814375 6.576875 -2.625 5.125 C-2 2 -2 2 0 0 Z " fill="${darkerShade}" transform="translate(269,82)"/>
<path d="M0 0 C36.63 0 73.26 0 111 0 C111 5.94 111 11.88 111 18 C74.37 18 37.74 18 0 18 C0 12.06 0 6.12 0 0 Z " fill="${lighterShade}" transform="translate(215,205)"/>
<path d="M0 0 C0.33 0 0.66 0 1 0 C1 1.65 1 3.3 1 5 C0.34 5 -0.32 5 -1 5 C-1.28875 5.61875 -1.5775 6.2375 -1.875 6.875 C-3 9 -3 9 -5 11 C-4.75 8.625 -4.75 8.625 -4 6 C-1.9375 4.6875 -1.9375 4.6875 0 4 C0 2.68 0 1.36 0 0 Z " fill="${adjustColorBrightness(color, 40)}" transform="translate(266,86)"/>
</svg>`;

    return `data:image/svg+xml;base64,${btoa(svg)}`;
};

/**
 * Adjust color brightness (helper function)
 */
function adjustColorBrightness(color: string, amount: number): string {
    const hex = color.replace('#', '');
    const r = Math.max(0, Math.min(255, parseInt(hex.substring(0, 2), 16) + amount));
    const g = Math.max(0, Math.min(255, parseInt(hex.substring(2, 4), 16) + amount));
    const b = Math.max(0, Math.min(255, parseInt(hex.substring(4, 6), 16) + amount));

    return `#${r.toString(16).padStart(2, '0')}${g.toString(16).padStart(2, '0')}${b.toString(16).padStart(2, '0')}`;
}

/**
 * Initialize default sthan types (run once)
 */
export const seedSthanTypes = async (): Promise<void> => {
    const defaultTypes: CreateSthanTypeInput[] = [
        { name: 'Avasthan', color: '#D4AF37', order: 1 },
        { name: 'Asan', color: '#0E3C6F', order: 2 },
        { name: 'Vasti', color: '#228B22', order: 3 },
        { name: 'Mandalik', color: '#6A0DAD', order: 4 },
    ];

    try {
        const existing = await getSthanTypes();
        if (existing.length === 0) {
            for (const type of defaultTypes) {
                await createSthanType(type);
            }
            console.log('Seeded default sthan types');
        }
    } catch (error) {
        console.error('Error seeding sthan types:', error);
    }
};
