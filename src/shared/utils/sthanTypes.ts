// src/utils/sthanTypes.ts
import { collection, getDocs, addDoc, updateDoc, deleteDoc, doc, query, orderBy, Timestamp } from 'firebase/firestore';
import { db } from '@/auth/firebase';
import { SthanType, CreateSthanTypeInput, UpdateSthanTypeInput } from '@/shared/types/sthanType';

const STHAN_TYPES_COLLECTION = 'sthan_types';

/**
 * Fetch all sthan types from Firestore
 */
export const getSthanTypes = async (): Promise<SthanType[]> => {
    try {
        const q = query(collection(db, STHAN_TYPES_COLLECTION), orderBy('order', 'asc'));
        const snapshot = await getDocs(q);

        return snapshot.docs.map(doc => ({
            id: doc.id,
            ...doc.data(),
        } as SthanType));
    } catch (error) {
        console.error('Error fetching sthan types:', error);
        return [];
    }
};

/**
 * Create a new sthan type
 */
export const createSthanType = async (data: CreateSthanTypeInput): Promise<string> => {
    try {
        const docRef = await addDoc(collection(db, STHAN_TYPES_COLLECTION), {
            ...data,
            createdAt: new Date().toISOString(),
            updatedAt: new Date().toISOString(),
        });
        return docRef.id;
    } catch (error) {
        console.error('Error creating sthan type:', error);
        throw error;
    }
};

/**
 * Update an existing sthan type
 */
export const updateSthanType = async (id: string, data: UpdateSthanTypeInput): Promise<void> => {
    try {
        const docRef = doc(db, STHAN_TYPES_COLLECTION, id);
        await updateDoc(docRef, {
            ...data,
            updatedAt: new Date().toISOString(),
        });
    } catch (error) {
        console.error('Error updating sthan type:', error);
        throw error;
    }
};

/**
 * Delete a sthan type
 */
export const deleteSthanType = async (id: string): Promise<void> => {
    try {
        const docRef = doc(db, STHAN_TYPES_COLLECTION, id);
        await deleteDoc(docRef);
    } catch (error) {
        console.error('Error deleting sthan type:', error);
        throw error;
    }
};

/**
 * Generate SVG pin data URL with custom color â€” dispatches by pinType
 */
export const generateSthanPinSVG = (color: string, pinType?: string): string => {
    if (pinType === 'aasan_sthan') return generateAasanSthanPinSVG(color);
    if (pinType === 'mahasthan') return '/icons/mahasthan pin.png';
    return generateDefaultPinSVG(color);
};

/**
 * Generate the default (generic) pin SVG with custom color
 */
const generateDefaultPinSVG = (color: string): string => {
    // Calculate complementary/darker shades based on the main color
    const darkerShade = adjustColorBrightness(color, -20);
    const lighterShade = adjustColorBrightness(color, 20);

    const svg = `<?xml version="1.0" encoding="UTF-8"?>
<svg version="1.1" xmlns="http://www.w3.org/2000/svg" width="500" height="500">
<path d="M0 0 C1.18258896 -0.00421463 1.18258896 -0.00421463 2.3890686 -0.0085144 C17.09668022 -0.00256496 31.29709088 1.9124912 45.375 6.3125 C46.20878174 6.56926514 47.04256348 6.82603027 47.90161133 7.09057617 C55.99346861 9.65715305 63.68337967 12.85408248 71.3125 16.5625 C71.99908691 16.89088867 72.68567383 17.21927734 73.39306641 17.55761719 C89.64729373 25.4178704 103.39663574 36.01408565 116.3125 48.5625 C116.86429932 49.09166016 117.41609863 49.62082031 117.98461914 50.16601562 C147.56385278 78.99996498 163.41718702 121.01841662 164.78442383 161.84448242 C165.46320359 224.53421984 122.47652912 293.90107807 91.97509766 346.68310547 C90.20795776 349.74355304 88.45302234 352.81079861 86.69921875 355.87890625 C73.94617149 378.1446772 60.72345205 400.10178198 47.04541016 421.81103516 C45.43674635 424.36522522 43.83287538 426.92235033 42.23046875 429.48046875 C31.5737055 446.46263938 20.59619742 463.24062684 9.43115234 479.89257812 C7.51146066 482.75828985 5.59992729 485.62943768 3.6875 488.5 C2 491.03125 2 491.03125 0.3125 493.5625 C-3.8590242 492.17199193 -5.1744977 489.23403421 -7.44921875 485.6875 C-7.91209793 484.97991043 -8.37497711 484.27232086 -8.85188293 483.54328918 C-10.36767755 481.22151552 -11.8714748 478.89223413 -13.375 476.5625 C-14.42127775 474.95363162 -15.46815666 473.34515403 -16.515625 471.73706055 C-19.58438556 467.01958252 -22.63712827 462.29188067 -25.6875 457.5625 C-26.48896717 456.32234573 -27.29055174 455.08226732 -28.09228516 453.84228516 C-41.47085464 433.12757177 -54.61730967 412.2628081 -67.20605469 391.05761719 C-68.71999073 388.50777765 -70.23888099 385.96092876 -71.7578125 383.4140625 C-85.62903974 360.10284358 -99.01955526 336.55051741 -111.6875 312.5625 C-112.32780208 311.35603478 -112.96826782 310.1496564 -113.60888672 308.94335938 C-128.98241912 279.95077249 -142.59864279 250.46659873 -153.6875 219.5625 C-154.00541504 218.69641113 -154.32333008 217.83032227 -154.65087891 216.93798828 C-156.51088682 211.85982166 -158.18598735 206.75786945 -159.6875 201.5625 C-159.92726563 200.75377441 -160.16703125 199.94504883 -160.4140625 199.11181641 C-163.97735383 186.66608374 -165.16154427 174.51677158 -165.1875 161.625 C-165.19423737 160.60223465 -165.19423737 160.60223465 -165.20111084 159.55880737 C-165.22880358 149.24108276 -163.89843693 139.61364366 -161.6875 129.5625 C-161.38972656 128.19387817 -161.38972656 128.19387817 -161.0859375 126.79760742 C-155.65643629 103.06567076 -145.13418402 81.43043304 -129.6875 62.5625 C-129.24325684 62.01287598 -128.79901367 61.46325195 -128.34130859 60.89697266 C-107.37451174 35.08227835 -79.73041269 16.03555019 -47.6875 6.5625 C-46.71619141 6.2747168 -45.74488281 5.98693359 -44.74414062 5.69042969 C-29.79789012 1.46729909 -15.4470298 0.00285109 0 0 Z " fill="${color}" transform="translate(270.6875,2.4375)"/>
<path d="M0 0 C17.77812368 14.98096049 29.49947374 34.84912009 32.58203125 58.17578125 C33.99760918 84.2550823 26.77896949 107.2549005 9.58203125 127.17578125 C8.9890625 127.86542969 8.39609375 128.55507812 7.78515625 129.265625 C-6.18200737 144.33703019 -27.74559782 153.57044143 -48.08984375 154.5234375 C-70.87549346 155.09641327 -90.05610544 149.92646986 -108.41796875 136.17578125 C-109.12050781 135.65757812 -109.82304687 135.139375 -110.546875 134.60546875 C-121.92457867 125.4573353 -129.97068686 112.55153469 -135.41796875 99.17578125 C-135.68899414 98.51191406 -135.96001953 97.84804687 -136.23925781 97.1640625 C-143.8439767 77.48126067 -143.07328813 53.35166505 -134.6875 34.1484375 C-124.3560916 11.63695355 -107.17107518 -4.20847124 -84.41796875 -13.82421875 C-55.20143425 -23.93172648 -24.5187649 -18.93128024 0 0 Z " fill="#F5F6F6" transform="translate(324.41796875,90.82421875)"/>
<path d="M0 0 C27.06 0 54.12 0 82 0 C82 15.51 82 31.02 82 47 C72.43 47 62.86 47 53 47 C52.75 34.8125 52.75 34.8125 52.70214844 30.99536133 C52.65622559 29.49138794 52.65622559 29.49138794 52.609375 27.95703125 C52.58842773 26.93585205 52.56748047 25.91467285 52.54589844 24.86254883 C51.86296201 21.28140859 50.53388653 19.58195093 48 17 C44.32872385 15.77624128 40.78168337 15.11252965 37 16 C33.94892233 17.57942511 32.77826256 18.19518705 31 21 C30.10417606 25.60403844 30.11670899 30.13333307 30.125 34.8125 C30.063125 41.3403125 30.063125 41.3403125 30 48 C20.1 48 10.2 48 0 48 C0 32.16 0 16.32 0 0 Z " fill="${darkerShade}" transform="translate(229,152)"/>
<path d="M0 0 C3.875 1.875 3.875 1.875 5 3 C5.04080783 4.99958364 5.04254356 7.00045254 5 9 C7.475 9.495 7.475 9.495 10 10 C12.29612756 19.41002278 12.29612756 19.41002278 12 24 C13.98 24 15.96 24 18 24 C18.495 26.475 18.495 26.475 19 29 C17.68 29 16.36 29 15 29 C15.495 32.465 15.495 32.465 16 36 C17.65 36 19.3 36 21 36 C21.93423645 39.01031744 22.04449911 39.86650268 21 43 C21.87914688 45.6569191 21.87914688 45.6569191 23 48 C24.32 48 25.64 48 27 48 C27.226875 48.721875 27.45375 49.44375 27.6875 50.1875 C29.44949326 53.96319984 30.51416118 55.58672697 34 58 C38.66364252 58.72522023 43.28478192 58.92981407 48 59 C48 60.98 48 62.96 48 65 C17.31 65 -13.38 65 -45 65 C-45 63.02 -45 61.04 -45 59 C-40.38 59 -35.76 59 -31 59 C-30.34 57.68 -29.68 56.36 -29 55 C-28.319375 54.690625 -27.63875 54.38125 -26.9375 54.0625 C-25.9784375 53.5365625 -25.9784375 53.5365625 -25 53 C-24.18828772 50.44480079 -24.18828772 50.44480079 -24 48 C-22.68 48 -21.36 48 -20 48 C-19.34 45.69 -18.68 43.38 -18 41 C-18.66 40.67 -19.32 40.34 -20 40 C-19.67 38.68 -19.34 37.36 -19 36 C-16.525 35.505 -16.525 35.505 -14 35 C-13.34 33.02 -12.68 31.04 -12 29 C-13.32 29 -14.64 29 -16 29 C-15.67 27.35 -15.34 25.7 -15 24 C-13.35 23.67 -11.7 23.34 -10 23 C-9.89042969 22.16855469 -9.78085937 21.33710937 -9.66796875 20.48046875 C-9.50941406 19.39378906 -9.35085938 18.30710937 -9.1875 17.1875 C-9.03667969 16.10855469 -8.88585937 15.02960938 -8.73046875 13.91796875 C-7.98249202 10.93006172 -7.47178858 9.7744578 -5 8 C-4.34 8 -3.68 8 -3 8 C-2.814375 6.576875 -2.814375 6.576875 -2.625 5.125 C-2 2 -2 2 0 0 Z " fill="${darkerShade}" transform="translate(269,82)"/>
<path d="M0 0 C36.63 0 73.26 0 111 0 C111 5.94 111 11.88 111 18 C74.37 18 37.74 18 0 18 C0 12.06 0 6.12 0 0 Z " fill="${lighterShade}" transform="translate(215,205)"/>
</svg>`;

    return `data:image/svg+xml;base64,${btoa(svg)}`;
};

/**
 * Generate the Aasan Sthan pin SVG with custom color tinting
 */
const generateAasanSthanPinSVG = (color: string): string => {
    const svg = `<?xml version="1.0" encoding="UTF-8"?>
<svg version="1.1" xmlns="http://www.w3.org/2000/svg" width="500" height="500">

<path d="M0 0 C0.86641113 0.24637207 1.73282227 0.49274414 2.62548828 0.74658203 C21.81682256 6.41085595 40.38660487 15.43722207 56 28 C56.54946289 28.43812012 57.09892578 28.87624023 57.66503906 29.32763672 C94.07775743 58.60329361 115.27846866 98.60484575 120.68652344 144.86376953 C127.30344921 211.0639475 80.67445533 285.72482017 48.66259766 341.12060547 C46.89545776 344.18105304 45.14052234 347.24829861 43.38671875 350.31640625 C30.63367149 372.5821772 17.41095205 394.53928198 3.73291016 416.24853516 C2.12424635 418.80272522 0.52037538 421.35985033 -1.08203125 423.91796875 C-11.7387945 440.90013938 -22.71630258 457.67812684 -33.88134766 474.33007812 C-35.80103934 477.19578985 -37.71257271 480.06693768 -39.625 482.9375 C-41.3125 485.46875 -41.3125 485.46875 -43 488 C-47.1715242 486.60949193 -48.4869977 483.67153421 -50.76171875 480.125 C-51.22459793 479.41741043 -51.68747711 478.70982086 -52.16438293 477.98078918 C-53.68017755 475.65901552 -55.1839748 473.32973413 -56.6875 471 C-57.73377775 469.39113162 -58.78065666 467.78265403 -59.828125 466.17456055 C-62.89688556 461.45708252 -65.94962827 456.72938067 -69 452 C-69.80146717 450.75984573 -70.60305174 449.51976732 -71.40478516 448.27978516 C-84.78335464 427.56507177 -97.92980967 406.7003081 -110.51855469 385.49511719 C-112.03249073 382.94527765 -113.55138099 380.39842876 -115.0703125 377.8515625 C-128.94153974 354.54034358 -142.33205526 330.98801741 -155 307 C-155.64030208 305.79353478 -156.28076782 304.5871564 -156.92138672 303.38085938 C-172.29491912 274.38827249 -185.91114279 244.90409873 -197 214 C-197.31791504 213.13391113 -197.63583008 212.26782227 -197.96337891 211.37548828 C-199.82338682 206.29732166 -201.49848735 201.19536945 -203 196 C-203.23976563 195.19127441 -203.47953125 194.38254883 -203.7265625 193.54931641 C-207.28985383 181.10358374 -208.47404427 168.95427158 -208.5 156.0625 C-208.50673737 155.03973465 -208.50673737 155.03973465 -208.51361084 153.99630737 C-208.54130358 143.67858276 -207.21093693 134.05114366 -205 124 C-204.70222656 122.63137817 -204.70222656 122.63137817 -204.3984375 121.23510742 C-198.96893629 97.50317076 -188.44668402 75.86793304 -173 57 C-172.55575684 56.45037598 -172.11151367 55.90075195 -171.65380859 55.33447266 C-150.68701174 29.51977835 -123.04291269 10.47305019 -91 1 C-90.02869141 0.7122168 -89.05738281 0.42443359 -88.05664062 0.12792969 C-59.74011948 -7.87303127 -28.32222521 -8.14270396 0 0 Z " fill="${color}" transform="translate(314,8)"/>
<path d="M0 0 C17.77812368 14.98096049 29.49947374 34.84912009 32.58203125 58.17578125 C33.99760918 84.2550823 26.77896949 107.2549005 9.58203125 127.17578125 C8.9890625 127.86542969 8.39609375 128.55507812 7.78515625 129.265625 C-5.23258427 143.31254586 -25.81613579 153.32806296 -44.88989258 154.30200195 C-69.03695609 154.9858395 -88.81391213 150.85671388 -108.41796875 136.17578125 C-109.12050781 135.65757812 -109.82304687 135.139375 -110.546875 134.60546875 C-121.92457867 125.4573353 -129.97068686 112.55153469 -135.41796875 99.17578125 C-135.68899414 98.51191406 -135.96001953 97.84804687 -136.23925781 97.1640625 C-143.8439767 77.48126067 -143.07328813 53.35166505 -134.6875 34.1484375 C-124.3560916 11.63695355 -107.17107518 -4.20847124 -84.41796875 -13.82421875 C-55.20143425 -23.93172648 -24.5187649 -18.93128024 0 0 Z " fill="#FBFBFB" transform="translate(324.41796875,90.82421875)"/>
<path d="M0 0 C1.25853287 0.19264938 2.51706573 0.38529877 3.81373596 0.58378601 C6.45241053 0.99040023 9.09019547 1.40064283 11.72729492 1.81713867 C15.09641171 2.34857095 18.46802552 2.86174653 21.84071255 3.36996174 C25.08291351 3.86133357 28.32256028 4.3689659 31.5625 4.875 C32.76772812 5.05638016 33.97295624 5.23776031 35.21470642 5.42463684 C36.33680008 5.60459702 37.45889374 5.78455719 38.61499023 5.9699707 C39.59805649 6.1231929 40.58112274 6.2764151 41.59397888 6.4342804 C46.15016101 7.60986257 48.70490181 9.2194621 51.31640625 13.13671875 C52.85326633 18.88883957 53.60642674 24.48732565 51.31640625 30.13671875 C45.83996368 36.76877519 37.70433261 40.93591032 30.44140625 45.32421875 C28.45094081 46.5876231 26.46391515 47.856464 24.48046875 49.13085938 C19.97332669 52.00735081 15.43984413 54.83227535 10.86131287 57.59376526 C9.10107306 58.66098247 7.35101985 59.74511696 5.60951233 60.84263611 C4.73443527 61.38779373 3.85935822 61.93295135 2.95776367 62.49462891 C1.78693489 63.2336998 1.78693489 63.2336998 0.592453 63.98770142 C-7.34124975 67.99287485 -17.1622388 64.0885886 -25.2286377 62.00302124 C-28.8835772 61.05825759 -32.5479911 60.15140316 -36.2109375 59.23828125 C-37.30065353 58.96485146 -37.30065353 58.96485146 -38.41238403 58.68589783 C-44.72652187 57.10720735 -51.06767698 55.67928891 -57.43359375 54.32421875 C-58.355354 54.12699219 -59.27711426 53.92976563 -60.22680664 53.7265625 C-61.93912212 53.360865 -63.65159493 52.99590298 -65.36425781 52.63183594 C-68.68356122 51.92325201 -71.99721615 51.19409433 -75.30859375 50.44921875 C-76.24960938 50.23910156 -77.190625 50.02898437 -78.16015625 49.8125 C-80.77150963 49.11317471 -83.19675038 48.19160718 -85.68359375 47.13671875 C-85.76497801 44.26114172 -85.82427226 41.38789613 -85.87109375 38.51171875 C-85.89623047 37.70347656 -85.92136719 36.89523438 -85.94726562 36.0625 C-85.95693359 35.26972656 -85.96660156 34.47695312 -85.9765625 33.66015625 C-85.99227295 32.93747559 -86.0079834 32.21479492 -86.02416992 31.47021484 C-85.54234282 28.16892205 -84.46545759 25.95711966 -82.68359375 23.13671875 C-80.08837891 21.35131836 -80.08837891 21.35131836 -76.84765625 19.8515625 C-76.24386139 19.56796371 -75.64006653 19.28436493 -75.01797485 18.99217224 C-72.91651903 18.01667187 -70.80176456 17.07534544 -68.68359375 16.13671875 C-67.88240112 15.77588196 -67.0812085 15.41504517 -66.2557373 15.04327393 C-60.83482241 12.60568915 -55.38637184 10.24028266 -49.91503906 7.91821289 C-48.00316611 7.10231702 -46.09527544 6.27702875 -44.19140625 5.44262695 C-41.3927344 4.21653073 -38.58308854 3.01959941 -35.76953125 1.828125 C-34.93481293 1.45635635 -34.1000946 1.08458771 -33.24008179 0.70155334 C-22.32221363 -3.8245168 -11.36563208 -1.78876195 0 0 Z " fill="${color}" transform="translate(285.68359375,119.86328125)"/>
<path d="M0 0 C3 2.0625 3 2.0625 5 5 C5.64566958 9.01749962 5.64663701 11.04682045 3.34375 14.44140625 C0.75063694 17.27222134 -1.8991489 19.26198917 -5.0625 21.4375 C-6.32136605 22.31489657 -7.57911846 23.19389245 -8.8359375 24.07421875 C-9.50850586 24.5439209 -10.18107422 25.01362305 -10.87402344 25.49755859 C-14.68657056 28.19191034 -18.43418807 30.97403678 -22.1875 33.75 C-22.97922607 34.33354248 -23.77095215 34.91708496 -24.58666992 35.51831055 C-28.82328617 38.64273531 -33.04827134 41.78189683 -37.26171875 44.9375 C-38.11805908 45.5759082 -38.97439941 46.21431641 -39.85668945 46.87207031 C-41.49797956 48.09599698 -43.13601222 49.32430786 -44.77026367 50.55761719 C-52.01490901 55.94890813 -56.92585822 57.6744775 -66 57 C-70.72356376 56.13461427 -75.34204469 54.93355638 -79.984375 53.7109375 C-81.32959803 53.36558744 -82.67508376 53.02125925 -84.02081299 52.67788696 C-87.55293806 51.77352978 -91.08112208 50.8546353 -94.60870361 49.93273926 C-98.12341365 49.01726965 -101.64199233 48.11692932 -105.16015625 47.21484375 C-111.88353962 45.48864755 -118.59775745 43.72911794 -125.31030273 41.96130371 C-128.7830914 41.05651278 -132.26179323 40.18062184 -135.74414062 39.31347656 C-137.73055724 38.80568457 -139.71689162 38.29757076 -141.703125 37.7890625 C-142.5865155 37.57704193 -143.46990601 37.36502136 -144.38006592 37.14657593 C-149.51230695 35.80703918 -152.64486414 34.36000324 -156 30 C-156.78154305 25.6233589 -156.51596953 23.78227638 -154.0625 20.0625 C-149.21489619 16.79778723 -144.43039777 17.55614839 -138.8918457 18.56762695 C-135.28879377 19.36902722 -131.70725376 20.23526728 -128.125 21.125 C-126.12864999 21.6089383 -124.1314291 22.0891573 -122.1341095 22.56907654 C-120.77315389 22.89621942 -119.41246704 23.22448231 -118.05204773 23.55384827 C-111.24390822 25.19773668 -104.40568309 26.69694405 -97.5625 28.1875 C-89.29835186 29.99219065 -81.12510986 31.9265978 -73.015625 34.3359375 C-64.07118786 36.30556744 -58.69669579 33.57297041 -51.21789551 28.88226318 C-46.30051495 25.72968248 -41.46267912 22.46046181 -36.625 19.1875 C-35.18265789 18.21755414 -33.73995153 17.24814973 -32.296875 16.27929688 C-30.87757327 15.32556681 -29.45830208 14.3717913 -28.0390625 13.41796875 C-27.34976151 12.9548378 -26.66046051 12.49170685 -25.95027161 12.01454163 C-22.76992063 9.87493354 -19.59706369 7.72641876 -16.4440918 5.54663086 C-15.38617432 4.8222583 -14.32825684 4.09788574 -13.23828125 3.3515625 C-12.32602783 2.71943848 -11.41377441 2.08731445 -10.47387695 1.43603516 C-6.54754634 -0.84311975 -4.42442848 -1.00908018 0 0 Z " fill="${color}" transform="translate(346,155)"/>
</svg>`;

    return `data:image/svg+xml;base64,${btoa(svg)}`;
};

/**
 * Adjust color brightness (helper function)
 */
function adjustColorBrightness(color: string, amount: number): string {
    const hex = color.replace('#', '');
    const r = Math.max(0, Math.min(255, parseInt(hex.substring(0, 2), 16) + amount));
    const g = Math.max(0, Math.min(255, parseInt(hex.substring(2, 4), 16) + amount));
    const b = Math.max(0, Math.min(255, parseInt(hex.substring(4, 6), 16) + amount));

    return `#${r.toString(16).padStart(2, '0')}${g.toString(16).padStart(2, '0')}${b.toString(16).padStart(2, '0')}`;
}

/**
 * Initialize default sthan types (run once)
 */
export const seedSthanTypes = async (): Promise<void> => {
    const defaultTypes: CreateSthanTypeInput[] = [
        { name: 'Avasthan', color: '#D4AF37', order: 1 },
        { name: 'Asan', color: '#0E3C6F', order: 2 },
        { name: 'Vasti', color: '#228B22', order: 3 },
        { name: 'Mandalik', color: '#6A0DAD', order: 4 },
    ];

    try {
        const existing = await getSthanTypes();
        if (existing.length === 0) {
            for (const type of defaultTypes) {
                await createSthanType(type);
            }
            console.log('Seeded default sthan types');
        }
    } catch (error) {
        console.error('Error seeding sthan types:', error);
    }
};
